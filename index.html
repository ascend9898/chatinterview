<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Mini-Interview</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
/* chat layout */
body{font-family:system-ui,sans-serif;background:#ece5dd;margin:0}
.wrapper{max-width:600px;margin:0 auto;height:100vh;display:flex;flex-direction:column}
.title{background:#075e54;color:#fff;padding:1rem;font-weight:600}
.box{flex:1;overflow-y:auto;padding:1rem;background:#e5ddd5}
.item{margin:.5rem 0;display:flex;align-items:flex-end}
.item .icon{width:32px;height:32px;border-radius:50%;background:#bbb;color:#fff;
           display:flex;align-items:center;justify-content:center;margin-right:.5rem}
.item.right{justify-content:flex-end}
.item.right .msg{background:#dcf8c6}
.msg{background:#fff;padding:.6rem .8rem;border-radius:6px;max-width:75%;
     box-shadow:0 1px 2px rgba(0,0,0,.1);word-break:break-word}

/* typing bar (position:relative enables absolute picker) */
.typing-area{padding:.7rem;background:#f0f0f0;position:relative}
.input-field{display:flex;align-items:center;gap:.5rem}
input[type=text]{flex:1;padding:.6rem;border:1px solid #ccc;border-radius:4px;
                 outline:none;font-size:1rem}
button{padding:.55rem .9rem;background:#128c7e;color:#fff;border:none;
       border-radius:4px;font-size:1rem;cursor:pointer}
button:disabled{background:#999;cursor:not-allowed}
#emojiBtn{background:#aaa}

/* emoji picker pops above the bar */
emoji-picker{position:absolute;bottom:60px;right:0;z-index:999;
             box-shadow:0 2px 6px rgba(0,0,0,.2)}
</style>

<!-- Supabase SDK â€“ UMD build -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<!-- Emoji-picker web-component -->
<script type="module"
        src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1"></script>
</head>
<body>
<div class="wrapper">
  <div class="title">Mini-Interview</div>
  <div class="box" id="chat"></div>

  <div class="typing-area">
    <div class="input-field">
      <input id="inp" type="text" placeholder="Type your reply"
             spellcheck="false" autocomplete="off" onpaste="return false">
      <button id="emojiBtn">ðŸ˜Š</button>
      <button id="send">Send</button>
      <emoji-picker id="picker" style="display:none"></emoji-picker>
    </div>
  </div>
</div>

<script>
/* 1 â€“ Supabase client (your keys) */
const sb = window.supabase.createClient(
  "https://yiuknemctptbpaaaotqv.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpdWtuZW1jdHB0YnBhYWFvdHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMzE4NjYsImV4cCI6MjA2NzkwNzg2Nn0.cX9115JCnsfiRi39S2MpxacKDpgChz3Gq9x59GHPz9Y"
);

/* 2 â€“ prompts */
const PROMPTS = [
  "What's your email address?",
  "What's your name?",
  "Hi Kellyâ€¦ I saw you on TikTok, I just had to see moreâ€”thatâ€™s why I subscribed here. Youâ€™re my type, my dream woman.",
  "Oh wow, you really replied, I wasnâ€™t expecting that!",
  "Iâ€™ve been admiring all your TikToks whenever Iâ€™m resting. Iâ€™m an interstate long-haul driver, btwâ€¦ You make my nights less lonely, to be honest.",
  "Iâ€™m parked at this truck stopâ€”the largest here in California. Iâ€™ve had my dinner and Iâ€™m just chilling, enjoying my Bud Light lolâ€¦ How was your day?"
];

/* 3 â€“ state */
let i = 0;
const chat   = document.getElementById("chat");
const inp    = document.getElementById("inp");
const send   = document.getElementById("send");
const picker = document.getElementById("picker");
const emojiBtn = document.getElementById("emojiBtn");

const meta   = {};
const answers = [];
let ks = [];

/* helper */
function bubble(text,right=false){
  const div=document.createElement("div");
  div.className="item"+(right?" right":"");
  if(!right){
    const ic=document.createElement("div");
    ic.className="icon"; ic.innerHTML='<i class="fa fa-user"></i>';
    div.appendChild(ic);
  }
  const m=document.createElement("div");
  m.className="msg"; m.textContent=text;
  div.appendChild(m);
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

/* first prompt */
bubble(PROMPTS[0]); inp.focus();

/* log keystrokes / edits / emoji adds */
function log(label){ ks.push({t:Date.now(),k:label}); }
inp.onkeydown = e=>log(e.key);
inp.addEventListener("input",()=>log("edit/emoji"));

/* emoji button */
emojiBtn.onclick = ()=>{picker.style.display = picker.style.display?"none":""; picker.focus();};
picker.addEventListener("emoji-click",e=>{
  inp.value += e.detail.unicode;
  log(e.detail.unicode);
  picker.style.display="none"; inp.focus();
});

/* send */
send.onclick = handle;
inp.addEventListener("keyup",e=>{if(e.key==="Enter")handle();});
async function handle(){
  const txt=inp.value.trim(); if(!txt) return;
  bubble(txt,true);

  if(i===0) meta.email=txt;
  if(i===1) meta.name =txt;
  answers.push({prompt:PROMPTS[i],answer:txt,keystrokes:ks});
  ks=[]; inp.value=""; inp.focus();

  i++;
  if(i<PROMPTS.length){
    setTimeout(()=>bubble(PROMPTS[i]),300);
  }else{
    bubble("âœ… Thanks, youâ€™re done!");
    inp.disabled=send.disabled=emojiBtn.disabled=true;

    /* insert & log any error */
    const {error}=await sb.from("interview_submissions").insert({
      name:meta.name||null,email:meta.email||null,
      answers,inserted_at:new Date().toISOString()
    });
    if(error) console.error("Supabase insert failed â†’",error.message);
  }
}
</script>
</body>
</html>
